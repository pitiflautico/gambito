# Room Manager (M√≥dulo Core)

**Estado:** ‚úÖ Implementado
**Tipo:** Core (obligatorio)
**Versi√≥n:** 1.0.0
**√öltima actualizaci√≥n:** 2025-10-21

---

## üìã Descripci√≥n

El **Room Manager** es un m√≥dulo core que gestiona la creaci√≥n, acceso y administraci√≥n de salas de juego. Proporciona funcionalidades para generar c√≥digos √∫nicos, QR codes, gestionar el lobby y controlar el ciclo de vida de las salas.

## üéØ Responsabilidades

- Crear salas de juego con c√≥digos √∫nicos de 6 caracteres
- Generar URLs de invitaci√≥n y QR codes
- Gestionar estados de sala (waiting, playing, finished)
- Validar condiciones para iniciar partidas
- Administrar el lobby con lista de jugadores en tiempo real
- Limpiar salas antiguas autom√°ticamente

## üéØ Cu√°ndo Usarlo

**Siempre.** Este es un m√≥dulo core que **todos los juegos** utilizan para:
- Crear salas antes de iniciar cualquier partida
- Permitir que jugadores se unan mediante c√≥digo/QR
- Gestionar el estado de espera en el lobby
- Controlar cu√°ndo una partida puede comenzar

## üì¶ Componentes

### Modelo: `Room`

**Ubicaci√≥n:** `app/Models/Room.php`

**Campos principales:**
```php
id              // Identificador √∫nico
code            // C√≥digo de 6 caracteres (√∫nico)
game_id         // Relaci√≥n con juego
master_id       // Usuario que cre√≥ la sala (master)
status          // Estado: waiting, playing, finished
settings        // JSON con configuraci√≥n personalizada
created_at      // Timestamp de creaci√≥n
updated_at      // Timestamp de √∫ltima actualizaci√≥n
```

**Relaciones:**
```php
game()          // BelongsTo - Juego asociado
master()        // BelongsTo - Usuario master
match()         // HasOne - Partida asociada
```

**M√©todos principales:**
```php
generateCode()              // Genera c√≥digo √∫nico de 6 caracteres
isWaiting()                 // Verifica si est√° en estado 'waiting'
isPlaying()                 // Verifica si est√° en estado 'playing'
isFinished()                // Verifica si est√° en estado 'finished'
canStart()                  // Verifica si puede iniciar (suficientes jugadores)
getInviteUrl()              // Genera URL de invitaci√≥n
getQrCodeUrl()              // Genera URL del QR code
```

---

### Servicio: `RoomService`

**Ubicaci√≥n:** `app/Services/Core/RoomService.php`

**M√©todos p√∫blicos:**

#### `createRoom(Game $game, User $master, array $settings = []): Room`
Crea una nueva sala de juego.

**Par√°metros:**
- `$game`: Juego seleccionado
- `$master`: Usuario que crea la sala
- `$settings`: Configuraci√≥n personalizada (opcional)

**Retorna:** Instancia de `Room`

**Ejemplo:**
```php
$game = Game::where('slug', 'pictionary')->first();
$master = auth()->user();
$room = $roomService->createRoom($game, $master, [
    'rounds' => 5,
    'timer' => 60
]);
```

---

#### `generateUniqueCode(): string`
Genera un c√≥digo √∫nico de 6 caracteres alfanum√©ricos.

**Formato:** `[A-Z0-9]{6}` excluyendo `0`, `O`, `I`, `1` (evita confusi√≥n)

**Retorna:** String de 6 caracteres (ej: `ABC123`)

**Ejemplo:**
```php
$code = $roomService->generateUniqueCode();
// Resultado: "XYZ789"
```

---

#### `isValidCodeFormat(string $code): bool`
Valida que un c√≥digo tenga el formato correcto.

**Par√°metros:**
- `$code`: C√≥digo a validar

**Retorna:** `true` si es v√°lido, `false` si no

**Ejemplo:**
```php
$roomService->isValidCodeFormat('ABC123'); // true
$roomService->isValidCodeFormat('abc123'); // false (min√∫sculas)
$roomService->isValidCodeFormat('AB12');   // false (longitud incorrecta)
```

---

#### `findRoomByCode(string $code): ?Room`
Busca una sala por su c√≥digo.

**Par√°metros:**
- `$code`: C√≥digo de sala

**Retorna:** Instancia de `Room` o `null` si no existe

**Ejemplo:**
```php
$room = $roomService->findRoomByCode('ABC123');
if ($room) {
    // Sala encontrada
}
```

---

#### `getInviteUrl(Room $room): string`
Genera URL de invitaci√≥n para unirse a la sala.

**Formato:** `https://gambito.test/rooms/join?code={code}`

**Retorna:** String con URL completa

**Ejemplo:**
```php
$url = $roomService->getInviteUrl($room);
// Resultado: "https://gambito.test/rooms/join?code=ABC123"
```

---

#### `getQrCodeUrl(Room $room, int $size = 200): string`
Genera URL del QR code usando QuickChart.io API.

**Par√°metros:**
- `$room`: Sala
- `$size`: Tama√±o del QR en p√≠xeles (default: 200)

**Retorna:** String con URL del QR code

**Ejemplo:**
```php
$qrUrl = $roomService->getQrCodeUrl($room);
// Resultado: "https://quickchart.io/qr?text=..."
```

---

#### `canStartGame(Room $room): bool`
Verifica si la partida puede iniciar.

**Condiciones:**
- Sala en estado `waiting`
- N√∫mero de jugadores >= m√≠nimo del juego
- N√∫mero de jugadores <= m√°ximo del juego

**Retorna:** `true` si puede iniciar, `false` si no

**Ejemplo:**
```php
if ($roomService->canStartGame($room)) {
    // Mostrar bot√≥n "Iniciar Partida"
}
```

---

#### `startGame(Room $room): GameMatch`
Inicia la partida asociada a la sala.

**Cambios:**
- Sala pasa a estado `playing`
- Crea instancia de `GameMatch`
- Asocia jugadores a la partida

**Retorna:** Instancia de `GameMatch`

**Ejemplo:**
```php
$match = $roomService->startGame($room);
```

---

#### `finishGame(Room $room, ?Player $winner = null): void`
Finaliza la partida.

**Cambios:**
- Sala pasa a estado `finished`
- Registra ganador (si existe)
- Marca timestamp de fin

**Ejemplo:**
```php
$roomService->finishGame($room, $winner);
```

---

#### `closeRoom(Room $room): void`
Cierra una sala (equivalente a `finishGame` sin ganador).

**Ejemplo:**
```php
$roomService->closeRoom($room);
```

---

#### `getRoomStats(Room $room): array`
Obtiene estad√≠sticas de la sala.

**Retorna:** Array con:
- `players_count`: N√∫mero de jugadores
- `duration`: Duraci√≥n de la partida (si finaliz√≥)
- `status`: Estado actual

**Ejemplo:**
```php
$stats = $roomService->getRoomStats($room);
// ['players_count' => 5, 'duration' => 1200, 'status' => 'finished']
```

---

#### `cleanupOldRooms(int $hoursOld = 24): int`
Limpia salas antiguas finalizadas.

**Par√°metros:**
- `$hoursOld`: Horas de antig√ºedad (default: 24)

**Retorna:** N√∫mero de salas eliminadas

**Ejemplo:**
```php
// Ejecutar en un comando scheduled
$deleted = $roomService->cleanupOldRooms(48); // Limpia salas de +48h
```

---

### Controlador: `RoomController`

**Ubicaci√≥n:** `app/Http/Controllers/RoomController.php`

**Rutas web:**
```php
GET  /rooms/create                    ‚Üí create()        (Auth)
POST /rooms                            ‚Üí store()         (Auth)
GET  /rooms/join                       ‚Üí join()          (Guest)
POST /rooms/join                       ‚Üí joinByCode()    (Guest)
GET  /rooms/{code}/guest-name          ‚Üí guestName()     (Guest)
POST /rooms/{code}/guest-name          ‚Üí storeGuestName() (Guest)
GET  /rooms/{code}/lobby               ‚Üí lobby()         (Auth/Guest)
GET  /rooms/{code}                     ‚Üí show()          (Auth/Guest)
GET  /rooms/{code}/results             ‚Üí results()       (Auth/Guest)
```

**Rutas API:**
```php
POST /api/rooms/{code}/start           ‚Üí apiStart()      (Auth - Master only)
GET  /api/rooms/{code}/stats           ‚Üí apiStats()      (Auth/Guest)
POST /api/rooms/{code}/close           ‚Üí apiClose()      (Auth - Master only)
```

**M√©todos principales:**

#### `create()`
Muestra formulario de creaci√≥n de sala.

**Vista:** `resources/views/rooms/create.blade.php`

---

#### `store(Request $request)`
Procesa creaci√≥n de sala.

**Validaci√≥n:**
- `game_id`: requerido, existe en BD
- `settings`: opcional, array

**Redirecci√≥n:** Lobby de la sala creada

---

#### `join()`
Muestra formulario para unirse por c√≥digo.

**Vista:** `resources/views/rooms/join.blade.php`

---

#### `joinByCode(Request $request)`
Procesa uni√≥n a sala por c√≥digo.

**Validaci√≥n:**
- `code`: requerido, 6 caracteres, existe en BD

**Redirecci√≥n:**
- Si es guest ‚Üí formulario de nombre
- Si est√° autenticado ‚Üí lobby

---

#### `guestName(string $code)`
Muestra formulario para ingresar nombre de invitado.

**Vista:** `resources/views/rooms/guest-name.blade.php`

---

#### `storeGuestName(Request $request, string $code)`
Procesa nombre de invitado y crea sesi√≥n.

**Validaci√≥n:**
- `name`: requerido, 2-20 caracteres, √∫nico en la sala

**Redirecci√≥n:** Lobby

---

#### `lobby(string $code)`
Muestra lobby con lista de jugadores.

**Vista:** `resources/views/rooms/lobby.blade.php`

**Caracter√≠sticas:**
- Lista de jugadores en tiempo real (auto-refresh 3s)
- Bot√≥n "Iniciar Partida" (solo master)
- C√≥digo y QR de invitaci√≥n
- URL compartible

---

#### `show(string $code)`
Muestra la partida en curso.

**Vista:** `resources/views/rooms/show.blade.php`

**Nota:** Actualmente es un placeholder que carga vistas espec√≠ficas del juego.

---

#### `results(string $code)`
Muestra resultados finales de la partida.

**Vista:** `resources/views/rooms/results.blade.php`

**Caracter√≠sticas:**
- Ranking de jugadores ordenado por puntuaci√≥n
- Estad√≠sticas de la partida
- Duraci√≥n total
- Opciones: jugar de nuevo, cambiar juego, salir

---

## üé® Vistas

### `create.blade.php`
Formulario de creaci√≥n de sala con:
- Selector de juego
- Configuraci√≥n opcional del juego
- Bot√≥n "Crear Sala"

---

### `join.blade.php`
Formulario para unirse por c√≥digo con:
- Input de c√≥digo de 6 caracteres
- Opci√≥n de escanear QR (m√≥vil)
- Bot√≥n "Unirse"

---

### `lobby.blade.php`
Lobby de espera con:
- C√≥digo de sala destacado
- QR code para compartir
- URL de invitaci√≥n con bot√≥n copiar
- Lista de jugadores conectados
- Estado de conexi√≥n en tiempo real
- Bot√≥n "Iniciar Partida" (solo master)
- Bot√≥n "Cerrar Sala" (solo master)
- Auto-refresh cada 3 segundos

---

### `guest-name.blade.php`
Formulario de nombre para invitados con:
- Input de nombre (2-20 caracteres)
- Validaci√≥n de nombres duplicados
- Bot√≥n "Continuar"

---

### `show.blade.php`
Vista de partida en curso (placeholder):
- Carga vista espec√≠fica del juego
- Layout base para juegos

---

### `results.blade.php`
Pantalla de resultados finales con:
- Ranking completo ordenado por puntuaci√≥n
- Destacado del ganador
- Estad√≠sticas de la partida
- Duraci√≥n total
- Botones: "Jugar de nuevo", "Cambiar juego", "Salir"

---

## üß™ Tests

**Ubicaci√≥n:** `tests/Feature/Core/RoomTest.php`, `tests/Unit/Services/Core/RoomServiceTest.php`

**Tests implementados:**
- ‚úÖ Crear sala requiere autenticaci√≥n
- ‚úÖ C√≥digo generado es √∫nico
- ‚úÖ QR code se genera correctamente
- ‚úÖ Jugadores pueden unirse con c√≥digo v√°lido
- ‚úÖ No se puede unir a sala inexistente
- ‚úÖ Master puede iniciar partida con suficientes jugadores
- ‚úÖ No se puede iniciar sin jugadores m√≠nimos
- ‚úÖ Nombres de invitados son √∫nicos por sala
- ‚úÖ Sala cambia a estado 'playing' al iniciar
- ‚úÖ Sala cambia a estado 'finished' al terminar

**Ejecutar tests:**
```bash
php artisan test --filter=RoomTest
php artisan test tests/Unit/Services/Core/RoomServiceTest.php
```

---

## üí° Ejemplos de Uso

### Crear sala desde controlador
```php
use App\Services\Core\RoomService;
use App\Models\Game;

public function store(Request $request, RoomService $roomService)
{
    $game = Game::findOrFail($request->game_id);
    $room = $roomService->createRoom($game, auth()->user(), [
        'rounds' => $request->input('rounds', 5)
    ]);

    return redirect()->route('rooms.lobby', $room->code);
}
```

### Validar y unirse a sala
```php
public function joinByCode(Request $request, RoomService $roomService)
{
    $room = $roomService->findRoomByCode($request->code);

    if (!$room || !$room->isWaiting()) {
        return back()->withErrors(['code' => 'Sala no encontrada o ya iniciada']);
    }

    // Redirigir seg√∫n tipo de usuario
    if (auth()->check()) {
        return redirect()->route('rooms.lobby', $room->code);
    }

    return redirect()->route('rooms.guestName', $room->code);
}
```

### Generar invitaci√≥n en vista
```blade
<div class="invitation">
    <p>C√≥digo: <strong>{{ $room->code }}</strong></p>
    <img src="{{ $room->getQrCodeUrl() }}" alt="QR Code">
    <input type="text" value="{{ $room->getInviteUrl() }}" readonly>
    <button onclick="copyToClipboard()">Copiar URL</button>
</div>
```

### Verificar si puede iniciar partida
```blade
@if($room->canStart())
    <form action="{{ route('api.rooms.start', $room->code) }}" method="POST">
        @csrf
        <button type="submit">Iniciar Partida</button>
    </form>
@else
    <p>Esperando m√°s jugadores ({{ $playersCount }}/{{ $game->min_players }})</p>
@endif
```

---

## üì¶ Dependencias

### Externas:
- **QuickChart.io API** - Generaci√≥n de QR codes (servicio externo gratuito)

### Internas:
- `Game` model
- `User` model (Laravel Breeze)
- `GameMatch` model
- `Player` model
- `PlayerSessionService` (para gesti√≥n de invitados)

---

## üîó Referencias

- **Modelo:** [`app/Models/Room.php`](../../../app/Models/Room.php)
- **Servicio:** [`app/Services/Core/RoomService.php`](../../../app/Services/Core/RoomService.php)
- **Controlador:** [`app/Http/Controllers/RoomController.php`](../../../app/Http/Controllers/RoomController.php)
- **Migration:** [`database/migrations/2025_10_20_181109_create_rooms_table.php`](../../../database/migrations/2025_10_20_181109_create_rooms_table.php)
- **Tests:** [`tests/Feature/Core/RoomTest.php`](../../../tests/Feature/Core/RoomTest.php)
- **Glosario:** [`docs/GLOSSARY.md`](../../GLOSSARY.md#sala--room)
- **PRD:** [`tasks/0001-prd-plataforma-juegos-sociales.md`](../../../tasks/0001-prd-plataforma-juegos-sociales.md)

---

**Mantenido por:** Todo el equipo de desarrollo
**√öltima revisi√≥n:** 2025-10-21
